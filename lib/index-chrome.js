/* ===================================================
 * JavaScript 2ch-client Library
 * https://github.com/sh19910711/js2ch
 * ===================================================
 * Copyright (c) 2013 Hiroyuki Sano
 *
 * Licensed under MIT License.
 * http://opensource.org/licenses/MIT
 * =================================================== */

(function(){var e=this;define("socket",["underscore"],function(e){var t=chrome.socket,n=function(){};n.prototype={};var r=e(n.prototype);return r.extend({create:function(){t.create.apply(this,arguments)}}),r.extend({destroy:function(){t.destroy.apply(this,arguments)}}),r.extend({connect:function(){t.connect.apply(this,arguments)}}),r.extend({disconnect:function(){t.disconnect.apply(this,arguments)}}),r.extend({read:function(){t.read.apply(this,arguments)}}),r.extend({write:function(){t.write.apply(this,arguments)}}),new n})})(),function(){"use strict";define("util",["jquery","underscore"],function(e,t){var n=function(){};n.prototype={};var r=t(n.prototype);return r.extend({getDeferredFunc:function(n){return function(){var t=this,r=new e.Deferred,i=arguments[arguments.length-1],s=Array.prototype.slice.apply(arguments);return setTimeout(function(){i instanceof Function?s[s.length-1]=function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}:s.push(function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}),n.apply(t,s)},0),r}}}),r.extend({splitString:function(t,n){var r=t.indexOf(n);return[t.substring(0,r),t.substring(r+n.length)]}}),r.extend({checkEmptyString:function(n){return e.trim(n).length===0}}),new n})}.call(this),function(){define("formatter",["underscore"],function(e){var t=function(){};t.prototype={};var n=e(t.prototype);return n.extend({format:function(t){return t}}),new t})}.call(this),function(){var e=this;define("logger",["underscore","formatter"],function(e,t){var n=function(){};n.prototype={};var r=e(n.prototype);r.extend({log:function(){console.log.apply(console,arguments)}}),r.extend({debug:function(){console.debug.apply(console,arguments)}}),r.extend({info:function(){console.info.apply(console,arguments)}}),r.extend({warn:function(){console.warn.apply(console,arguments)}}),r.extend({error:function(){console.error.apply(console,arguments)}});var i=["log","debug","info","warn","error"];return e(i).each(function(r){var i=n.prototype[r];n.prototype[r]=function(){var n=Array.prototype.slice.apply(arguments);n=e(n).map(function(e){return t.format(e)}),i.apply(this,n)}}),new n})}.call(this),function(){define("buffer-lib",["underscore","encoding","logger"],function(e,t,n){var r=function(){};r.prototype={};var i=e(r.prototype);return i.extend({convertToString:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsText(new Blob([new Uint8Array(t)]),"sjis")}}),i.extend({convertToBuffer:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsArrayBuffer(new Blob([t]))}}),i.extend({getByteLength:function(t,n){setTimeout(function(){n((new Blob([t])).size)},0)}}),new r})}.call(this),function(){var e=this;define("http-lib",["jquery","underscore","socket","purl","async","util","buffer-lib","logger"],function(e,t,n,r,i,s,o,u){function h(t,n){var r=new e.Deferred;return n instanceof Function||(n=r.resolve),o.convertToBuffer(t,n),r}function p(t){var n=t.split(a),r=n[0].split(" "),i=n.slice(1),o=i.map(function(t){return s.splitString(t,":").map(e.trim)}),u={"HTTP-Version":r[0],"Status-Code":r[1]};return o.forEach(function(e){u[e[0]]=e[1]}),u}function d(e){return s.splitString(e,a+a)[0]}function v(e){return s.splitString(e,a+a)[1]}function m(e){return t(t.keys(e)).map(function(t){return t+"="+e[t]}).join("&")}function g(e){var t=p(d(e)),n={headers:t,body:v(e)};return n}var a="\r\n",f=80,l=function(){};l.prototype={};var c=t(l.prototype);c.extend({get:function(s,u,l){function m(e){n.create("tcp",{},function(t){v=t.socketId,e(null)})}function y(e){n.connect(v,d.host,d.port,function(){var r=[];r.push("GET "+d.path+" HTTP/1.0"+a),t(t.keys(u)).each(function(e){r.push(e+": "+u[e]+a)}),r.push("Connection: close"+a),r.push(a);var i=r.join("");h(i).done(function(t){n.write(v,t,function(){e(null)})})})}function b(e){function u(){n.read(v,256,function(i){if(i.resultCode<0)clearTimeout(s),r=t(r).map(function(e){return e}),n.destroy(v),o.convertToString(r,function(t){c=g(t),e(null)});else{var a=[],f=new Uint8Array(i.data);t(f).each(function(e){a.push(e)}),r=r.concat(a),s=setTimeout(u,0)}})}var r=[],i="",s=setTimeout(u,0)}var c={},p=e.url(s),d={host:p.attr("host"),path:p.attr("path"),port:parseInt(p.attr("port")||f,10)},v;i.series([m,y,b],function(){l(c)})}}),c.extend({post:function(s,u,l,c){function b(e){n.create("tcp",{},function(t){y=t.socketId,e(null)})}function w(e){n.connect(y,v.host,v,function(){function f(o){v.query!=""&&(i+="?"+v.query),r.push("POST "+i+" HTTP/1.1"+a),t(t.keys(u)).each(function(e){r.push(e+": "+u[e]+a)}),r.push("Content-Length: "+o+a),r.push("Connection: close"+a),r.push(a),r.push(s);var f=r.join("");h(f).done(function(t){n.write(y,t,function(){e(null)})})}var r=[],i=v.path,s=m(l);o.getByteLength(s,f)})}function E(e){function u(){n.read(y,256,function(i){if(i.resultCode<0)clearTimeout(s),r=t(r).map(function(e){return e}),n.destroy(y),o.convertToString(r,function(t){p=g(t),e(null)});else{var a=[],f=new Uint8Array(i.data);t(f).each(function(e){a.push(e)}),r=r.concat(a),s=setTimeout(u,0)}})}var r=[],i="",s=setTimeout(u,0)}var p={},d=e.url(s),v={host:d.attr("host"),path:d.attr("path"),query:d.attr("query"),port:d.attr("port")||f},y;i.series([b,w,E],function(){c(p)})}});var y=["get","post"];return t(y).each(function(e){l.prototype[e]=s.getDeferredFunc(l.prototype[e])}),new l})}.call(this),function(){var e=this;define("storage",["jquery","underscore","util"],function(e,t,n){var r=chrome.storage.local,i=function(){};i.prototype={};var s=t(i.prototype);s.extend({get:function(t,n){r.get.apply(r,arguments)}}),s.extend({set:function(t,n){r.set.apply(r,arguments)}}),s.extend({remove:function(t,n){r.remove.apply(r,arguments)}}),s.extend({clear:function(t){r.clear.apply(r,arguments)}});var o=["get","set","remove","clear"];return t(o).each(function(e){i.prototype[e]=n.getDeferredFunc(i.prototype[e])}),new i})}.call(this),function(){var e=this;define("parser",["underscore","jquery","logger","util"],function(e,t,n,r){var i=function(){this.token="<>"};i.prototype={};var s=e(i.prototype);return s.extend({parseThreadList:function(i){function s(e){return t.trim(e)}function o(e){return t.trim(e.match(/(.*)\([0-9]+\)$/)[1])}function u(e){return parseInt(e.match(/.*\(([0-9]+)\)$/)[1],10)}function a(e){var t=r.splitString(e,this.token);return{filename:s(t[0]),subject:o(t[1]),responses:u(t[1])}}return e(i.split("\n")).reject(r.checkEmptyString).map(a.bind(this))}}),s.extend({parseResponsesFromThread:function(i){function s(e){var n={};return e=t.trim(e),e[0]=="<"?n={data:e.match(/<\/b>(.*)<b>/)[1],strong:!1}:n={data:e,strong:!0},n}function o(e){return t.trim(e)}function u(e){return t.trim(e)}function a(e){return t.trim(e)}function f(e){return t.trim(e)}function l(e,t){var n=e.split(this.token);return{number:t+1,name:s(n[0]),mail:o(n[1]),info:u(n[2]),body:a(n[3]),subject:f(n[4])}}var c=e(i.split("\n")).reject(r.checkEmptyString).map(l.bind(this));return c}}),new i})}.call(this),function(){var e=this;define("client",["jquery","underscore","backbone","http-lib","storage","parser","encoding","util","logger"],function(e,t,n,r,i,s,o,u,a){function c(e,t){return"http://"+e+t}function h(e,t){return"/dat/"+t+".dat"}function p(e){return o.codeToString(o.convert(v(e),"SJIS","AUTO"))}function d(e){return t(e).map(function(e){return"%"+e.charCodeAt().toString(16).toUpperCase()}).join("")}function v(e){var n=[];return t(e.split("")).each(function(e){n.push(e.charCodeAt())}),n}var f=function(){this.HTTP_REQ_HEADERS_DEFAULT={"User-Agent":"Monazilla/1.00"}};f.prototype={};var l=t(f.prototype);l.extend({getThreadList:function(n,i,o){var u=c(n,"/"+i+"/subject.txt");r.get(u,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){o(s.parseThreadList(e.body))})}}),l.extend({getSettingText:function(n,i,o){var u=c(n,"/"+i+"/SETTING.TXT");r.get(u,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){o(s.parseSettingText(e.body))})}}),l.extend({getResponsesFromThread:function(n,i,o,u){var a=c(n,"/"+i+h(n,o));r.get(a,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){u(s.parseResponsesFromThread(e.body))})}}),l.extend({putResponseToThread:function(s,o,a,f,l){function m(n){function s(t){var r=[];typeof t.headers["Set-Cookie"]!="undefined"&&r.push(l(t.headers["Set-Cookie"])),e.when.apply(null,r).done(function(){n(t)})}function l(n,r){function s(){return t(n.split(";")).each(function(n){var r=u.splitString(n,"="),i=e.trim(r[0]),s=e.trim(r[1]);if(i==="expires"||i==="path")return;var a={};a[i]=s,t(o).extend(a)}),typeof o["HAP"]=="undefined"&&(o.HAP=""),i.set({cookies:o})}var o={};return Array.isArray(n)?e.when.apply(null,t(n).map(l)):e.when.apply(null,[i.get("cookies").done(function(e){t(o).extend(e.cookies)})]).done(s)}var c=t(f).clone();t(c).each(function(e,t){c[t]=p(e)});var m=t(c).clone();t(m).each(function(e,t){m[t]=d(e)}),r.post(h,v,{bbs:o,key:a,time:1,submit:p("上記全てを承諾して書き込む"),FROM:m.name,mail:m.mail,MESSAGE:m.body,yuki:"akari"}).done(s)}function g(e){var n=t.keys(e),r=t(n).map(function(t){return t+"="+e[t]});return r.join("; ")}var h=c(s,"/test/bbs.cgi?guid=ON"),v=t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:s,Referer:c(s,"/"+o+"/")});e.when.apply(null,[i.get("cookies").done(function(e){typeof e.cookies!="undefined"&&t(v).extend({Cookie:g(e.cookies)})})]).done(function(){m(l)})}});var m=["getThreadList","getSettingText","getResponsesFromThread","putResponseToThread"];return t(m).each(function(e){f.prototype[e]=u.getDeferredFunc(f.prototype[e])}),new f})}.call(this),function(){var e=this;requirejs.config({paths:{client:"../sources/client",socket:"../sources/socket-chrome",storage:"../sources/storage-chrome","http-lib":"../sources/http-lib","buffer-lib":"../sources/buffer-lib-chrome",util:"../sources/util",parser:"../sources/parser",logger:"../sources/logger",formatter:"../sources/formatter"}}),define(["client"],function(e){return e})}.call(this);