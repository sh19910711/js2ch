/* ===================================================
 * JavaScript 2ch-client Library
 * https://github.com/sh19910711/js2ch
 * ===================================================
 * Copyright (c) 2013 Hiroyuki Sano
 *
 * Licensed under MIT License.
 * http://opensource.org/licenses/MIT
 * =================================================== */

(function(){var e=this;define("socket",[],function(){return chrome.socket})}).call(this),function(){"use strict";define("util",["jquery","underscore"],function(e,t){var n=function(){};n.prototype={};var r=t(n.prototype);return r.extend({getDeferredFunc:function(n){return function(){var t=this,r=new e.Deferred,i=arguments[arguments.length-1],s=Array.prototype.slice.apply(arguments);return setTimeout(function(){i instanceof Function?s[s.length-1]=function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}:s.push(function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}),n.apply(t,s)},0),r}}}),r.extend({splitString:function(t,n){var r=t.indexOf(n);return[t.substring(0,r),t.substring(r+n.length)]}}),new n})}.call(this),function(){define("buffer-lib",["underscore","encoding"],function(e,t){var n=function(){};n.prototype={};var r=e(n.prototype);return r.extend({convertToString:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsText(new Blob([new Uint8Array(t)]),"sjis")}}),r.extend({convertToBuffer:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsArrayBuffer(new Blob([t]))}}),r.extend({getByteLength:function(t,n){setTimeout(function(){n((new Blob([t])).size)},0)}}),new n})}.call(this),function(){var e=this;define("http-lib",["jquery","underscore","socket","purl","async","util","buffer-lib"],function(e,t,n,r,i,s,o){function l(t,n){var r=new e.Deferred;return n instanceof Function||(n=r.resolve),o.convertToBuffer(t,n),r}function c(t){var n=t.split(u),r=n[0].split(" "),i=n.slice(1),o=i.map(function(t){return s.splitString(t,":").map(e.trim)}),a={"HTTP-Version":r[0],"Status-Code":r[1]};return o.forEach(function(e){a[e[0]]=e[1]}),a}function h(e){return s.splitString(e,u+u)[0]}function p(e){return s.splitString(e,u+u)[1]}function d(e){return t(t.keys(e)).map(function(t){return t+"="+e[t]}).join("&")}function v(e){var t=c(h(e)),e={headers:t,body:p(e)};return e}var u="\r\n",a=function(){};a.prototype={};var f=t(a.prototype);f.extend({get:function(s,a,f){function m(e){n.create("tcp",{},function(t){d=t.socketId,e(null)})}function g(e){n.connect(d,p.host,80,function(){var r=[];r.push("GET "+p.path+" HTTP/1.0"+u),t(t.keys(a)).each(function(e){r.push(e+": "+a[e]+u)}),r.push("Connection: close"+u),r.push(u);var i=r.join("");l(i).done(function(t){n.write(d,t,function(){e(null)})})})}function y(e){function u(){n.read(d,256,function(i){if(i.resultCode<0)clearTimeout(s),r=t(r).map(function(e){return e}),n.destroy(d),o.convertToString(r,function(t){c=v(t),e(null)});else{var a=[],f=new Uint8Array(i.data);t(f).each(function(e){a.push(e)}),r=r.concat(a),s=setTimeout(u,0)}})}var r=[],i="",s=setTimeout(u,0)}var c={},h=e.url(s),p={host:h.attr("host"),path:h.attr("path")},d;i.series([m,g,y],function(){f(c)})}}),f.extend({post:function(s,a,f,c){function y(e){n.create("tcp",{},function(t){g=t.socketId,e(null)})}function b(e){n.connect(g,m.host,80,function(){function c(o){m.query!=""&&(i+="?"+m.query),r.push("POST "+i+" HTTP/1.1"+u),t(t.keys(a)).each(function(e){r.push(e+": "+a[e]+u)}),r.push("Content-Length: "+o+u),r.push("Connection: close"+u),r.push(u),r.push(s);var f=r.join("");l(f).done(function(t){n.write(g,t,function(){e(null)})})}var r=[],i=m.path,s=d(f);o.getByteLength(s,c)})}function w(e){function u(){n.read(g,256,function(i){if(i.resultCode<0)clearTimeout(s),r=t(r).map(function(e){return e}),n.destroy(g),o.convertToString(r,function(t){h=v(t),e(null)});else{var a=[],f=new Uint8Array(i.data);t(f).each(function(e){a.push(e)}),r=r.concat(a),s=setTimeout(u,0)}})}var r=[],i="",s=setTimeout(u,0)}var h={},p=e.url(s),m={host:p.attr("host"),path:p.attr("path"),query:p.attr("query")},g;i.series([y,b,w],function(){c(h)})}});var m=["get","post"];return t(m).each(function(e){a.prototype[e]=s.getDeferredFunc(a.prototype[e])}),new a})}.call(this),function(){var e=this;define("storage",["jquery","underscore","util"],function(e,t,n){var r=chrome.storage.local,i=function(){};i.prototype={};var s=t(i.prototype);s.extend({get:function(t,n){r.get.apply(r,arguments)}}),s.extend({set:function(t,n){r.set.apply(r,arguments)}}),s.extend({remove:function(t,n){r.remove.apply(r,arguments)}}),s.extend({clear:function(t){r.clear.apply(r,arguments)}});var o=["get","set","remove","clear"];return t(o).each(function(e){i.prototype[e]=n.getDeferredFunc(i.prototype[e])}),new i})}.call(this),function(){var e=this;define("parser",[],function(){return console.log("@parser: test"),{}})}.call(this),function(){var e=this;define("client",["jquery","underscore","http-lib","storage","parser","encoding","util"],function(e,t,n,r,i,s,o){function f(e,t){return"http://"+e+t}function l(e,t){return"/dat/"+t+".dat"}function c(e){return s.codeToString(s.convert(p(e),"SJIS","AUTO"))}function h(e){return t(e).map(function(e){return"%"+e.charCodeAt().toString(16).toUpperCase()}).join("")}function p(e){var n=[];return t(e.split("")).each(function(e){n.push(e.charCodeAt())}),n}var u=function(){this.HTTP_REQ_HEADERS_DEFAULT={"User-Agent":"Monazilla/1.00"}};u.prototype={};var a=t(u.prototype);a.extend({testHoge:function(){console.log("@hoge: http = ",n)}}),a.extend({getThreadList:function(r,i,s){var o=f(r,"/"+i+"/subject.txt");n.get(o,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:r})).done(function(){s.apply(this,arguments)})}}),a.extend({getSettingText:function(r,i,s){var o=f(r,"/"+i+"/SETTING.TXT");n.get(o,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:r}))}}),a.extend({getResponsesFromThread:function(r,i,s,o){var u=f(r,"/"+i+l(r,s));n.get(u,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:r}))}}),a.extend({putResponseToThread:function(s,u,a,l,p){function m(i){function s(t){var n=[];typeof t.headers["Set-Cookie"]!="undefined"&&n.push(f(t.headers["Set-Cookie"])),e.when.apply(null,n).done(function(){i(t)})}function f(n,i){function s(){return t(n.split(";")).each(function(n){var r=o.splitString(n,"="),i=e.trim(r[0]),s=e.trim(r[1]);if(i==="expires"||i==="path")return;var a={};a[i]=s,t(u).extend(a)}),typeof u["HAP"]=="undefined"&&(u.HAP=""),r.set({cookies:u})}var u={};return Array.isArray(n)?e.when.apply(null,t(n).map(f)):e.when.apply(null,[r.get("cookies").done(function(e){t(u).extend(e.cookies)})]).done(s)}var p=t(l).clone();t(p).each(function(e,t){p[t]=c(e)});var m=t(p).clone();t(m).each(function(e,t){m[t]=h(e)}),n.post(d,v,{bbs:u,key:a,time:1,submit:c("上記全てを承諾して書き込む"),FROM:m.name,mail:m.mail,MESSAGE:m.body,yuki:"akari"}).done(s)}function g(e){var n=t.keys(e),r=t(n).map(function(t){return t+"="+e[t]});return r.join("; ")}var d=f(s,"/test/bbs.cgi?guid=ON"),v=t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:s,Referer:f(s,"/"+u+"/")});e.when.apply(null,[r.get("cookies").done(function(e){typeof e.cookies!="undefined"&&t(v).extend({Cookie:g(e.cookies)})})]).done(function(){m(p)})}});var d=["getThreadList","getSettingText","getResponsesFromThread","putResponseToThread"];return t(d).each(function(e){u.prototype[e]=o.getDeferredFunc(u.prototype[e])}),new u})}.call(this),function(){var e=this;requirejs.config({paths:{client:"../sources/client",socket:"../sources/socket-chrome",storage:"../sources/storage-chrome","http-lib":"../sources/http-lib","buffer-lib":"../sources/buffer-lib-chrome",util:"../sources/util",parser:"../sources/parser",logger:"../sources/logger"}}),define(["client"],function(e){return e})}.call(this);