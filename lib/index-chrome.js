/* ===================================================
 * JavaScript 2ch-client Library
 * https://github.com/sh19910711/js2ch
 * ===================================================
 * Copyright (c) 2013 Hiroyuki Sano
 *
 * Licensed under MIT License.
 * http://opensource.org/licenses/MIT
 * =================================================== */

(function(){"use strict";define("util-lib",["jquery","underscore"],function(e,t){var n=function(){},r=function(e){t.extend(n,e)};return r({getDeferredFunc:function(n,r,i){return function(){r=this||r,i=i||r;var t=new e.Deferred,s=arguments[arguments.length-1],o=Array.prototype.slice.apply(arguments);return s instanceof Function?o[o.length-1]=function(){s instanceof Function&&s.apply(i,arguments),t.resolveWith(i,arguments)}:o.push(function(){s instanceof Function&&s.apply(i,arguments),t.resolveWith(i,arguments)}),n.apply(r,o),t}}}),r({getDeferredFuncWillFail:function(n,r,i){return function(){r=this||r,i=i||r;var t=new e.Deferred,s=Array.prototype.slice.apply(arguments),o=function(){},u=function(){};return s[s.length-2]instanceof Function&&s[s.length-1]instanceof Function?(o=arguments[arguments.length-2],u=arguments[arguments.length-1],s[s.length-2]=function(){o instanceof Function&&o.apply(i,arguments),t.resolveWith(i,arguments)},s[s.length-1]=function(){u instanceof Function&&u.apply(i,arguments),t.rejectWith(i,arguments)}):s[s.length-1]instanceof Function?(o=arguments[arguments.length-1],s[s.length-1]=function(){o instanceof Function&&o.apply(i,arguments),t.resolveWith(i,arguments)},s.push(function(){t.rejectWith(i,arguments)})):(s.push(function(){t.resolveWith(i,arguments)}),s.push(function(){t.rejectWith(i,arguments)})),n.apply(r,s),t}}}),r({splitString:function(t,n){var r=t.indexOf(n);return[t.substring(0,r),t.substring(r+n.length)]}}),r({checkEmptyString:function(n){return e.trim(n).length===0}}),n})})(),function(){var e=this;define("socket",["underscore","util-lib"],function(e,t){var n=chrome.socket,r=function(n,r){r=r||this,n=n&&n.socket||n||{};var i=["connect","create","read","write"];e(i).each(function(e){this[e]=t.getDeferredFunc(this[e],this,r)},this)};r.prototype={};var i=function(t){e.extend(r.prototype,t)};return i({create:function(){n.create.apply(n,arguments)}}),i({destroy:function(){n.destroy.apply(n,arguments)}}),i({connect:function(){n.connect.apply(n,arguments)}}),i({disconnect:function(){n.disconnect.apply(n,arguments)}}),i({read:function(){n.read.apply(n,arguments)}}),i({write:function(){n.write.apply(n,arguments)}}),r})}(),function(){define("formatter",["underscore"],function(e){var t=function(){};t.prototype={};var n=function(n){e.extend(t.prototype,n)};return n({format:function(t){return t}}),t})}(),function(){var e=this;define("logger",["underscore","formatter"],function(e,t){var n=function(){};n.prototype={};var r=function(t){e.extend(n.prototype,t)};r({log:function(){console.log.apply(console,arguments)}}),r({debug:function(){console.debug.apply(console,arguments)}}),r({info:function(){console.info.apply(console,arguments)}}),r({warn:function(){console.warn.apply(console,arguments)}}),r({error:function(){console.error.apply(console,arguments)}});var i=["log","debug","info","warn","error"];return e(i).each(function(r){var i=n.prototype[r];n.prototype[r]=function(){var n=Array.prototype.slice.apply(arguments);n=e(n).map(function(e){return t.format(e)}),i.apply(this,n)}}),n})}(),function(){define("buffer-lib",["underscore","encoding","logger","util-lib"],function(e,t,n,r){var i=function(t,n){n=n||this,t=t&&t["buffer-lib"]||t||{};var i=["convertToString","convertToBuffer","getByteLength"];e(i).each(function(e){this[e]=r.getDeferredFunc(this[e],this,n)},this)};i.prototype={};var s=function(t){e.extend(i.prototype,t)};return s({convertToString:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsText(new Blob([new Uint8Array(t)]),"sjis")}}),s({convertToBuffer:function(t,n){var r=new FileReader;r.onloadend=function(){n(r.result)},r.readAsArrayBuffer(new Blob([t]))}}),s({getByteLength:function(t,n){setTimeout(function(){n((new Blob([t])).size)},0)}}),i})}(),function(){var e=this;define("http-lib",["jquery","underscore","socket","purl","async","util-lib","buffer-lib","logger"],function(e,t,n,r,i,s,o,u){function h(t){var n=t.split(a),r=n[0].split(" "),i=n.slice(1),o=i.map(function(t){return s.splitString(t,":").map(e.trim)}),u={"HTTP-Version":r[0],"Status-Code":r[1]};return o.forEach(function(e){u[e[0]]=e[1]}),u}function p(e){return s.splitString(e,a+a)[0]}function d(e){return s.splitString(e,a+a)[1]}function v(e){return t(t.keys(e)).map(function(t){return t+"="+e[t]}).join("&")}function m(e){var t=h(p(e)),n={headers:t,headers_source:p(e),body:d(e)};return n}var a="\r\n",f=80,l=function(e,r){r=r||this,e=e&&e["http-lib"]||e,this.socket=new n(e&&e.socket||e,this),this.buffer_lib=new o(e&&e.buffer_lib||e,this),this.logger=new u(e&&e.logger||e,this);var i=["get","post"];t(i).each(function(e){this[e]=s.getDeferredFunc(this[e],this,r)},this)};l.prototype={};var c=function(e){t.extend(l.prototype,e)};return c({get:function(r,s,o){var u={},l=e.url(r),c={host:l.attr("host"),path:l.attr("path")||"/",port:parseInt(l.attr("port")||f,10)},h,p=function(t){this.socket.create("tcp",{}).done(function(e){h=e.socketId,t(null)})};p=p.bind(this);var d=function(n){this.socket.connect(h,c.host,c.port).done(function(){var e=function(t){this.socket.write(h,t).done(function(){n(null)})};e=e.bind(this);var r=[];r.push("GET "+c.path+" HTTP/1.0"+a),t(t.keys(s)).each(function(e){r.push(e+": "+s[e]+a)}),r.push("Connection: close"+a),r.push(a);var i=r.join("");this.buffer_lib.convertToBuffer(i).done(e)})};d=d.bind(this);var v=function(n){var r=function(){this.socket.read(h,256).done(function(e){if(e.resultCode<0)clearTimeout(o),this.socket.destroy(h),this.buffer_lib.convertToString(i).done(function(e){u=m(e),n(null)});else{var s=[],a=new Uint8Array(e.data);t(a).each(function(e){s.push(e)}),i=i.concat(s),o=setTimeout(r,0)}})};r=r.bind(this);var i=[],s="",o=setTimeout(r,0)};v=v.bind(this),i.series([p,d,v],function(){o(u)})}}),c({post:function(r,s,o,u){var l={},c=e.url(r),h={host:c.attr("host"),path:c.attr("path")||"/",query:c.attr("query"),port:c.attr("port")||f},p,d=function(t){this.socket.create("tcp",{}).done(function(e){p=e.socketId,t(null)})};d=d.bind(this);var g=function(n){this.socket.connect(p,h.host,h.port).done(function(){var e=function(t){this.socket.write(p,t,function(){n(null)})};e=e.bind(this);var r=function(r){h.query!=""&&(u+="?"+h.query),i.push("POST "+u+" HTTP/1.1"+a),t(t.keys(s)).each(function(e){i.push(e+": "+s[e]+a)}),i.push("Content-Type: application/x-www-form-urlencoded"+a),i.push("Content-Length: "+r+a),i.push("Connection: close"+a),i.push(a),i.push(f);var o=i.join("");this.buffer_lib.convertToBuffer(o).done(e)};r=r.bind(this);var i=[],u=h.path,f=v(o);this.buffer_lib.getByteLength(f).done(r)})};g=g.bind(this);var y=function(n){var r=function(){this.socket.read(p,256).done(function(e){if(e.resultCode<0)clearTimeout(o),i=t(i).map(function(e){return e}),this.socket.destroy(p),this.buffer_lib.convertToString(i).done(function(e){l=m(e),n(null)});else{var s=[],u=new Uint8Array(e.data);t(u).each(function(e){s.push(e)}),i=i.concat(s),o=setTimeout(r,0)}})};r=r.bind(this);var i=[],s="",o=setTimeout(r,0)};y=y.bind(this),i.series([d,g,y],function(){u(l)})}}),l})}(),function(){var e=this;define("storage",["jquery","underscore","util-lib"],function(e,t,n){var r=chrome.storage.local,i=function(e,r){r=r||this,e=e&&e.storage||e||{};var i=["get","set","remove","clear"];t(i).each(function(e){this[e]=n.getDeferredFunc(this[e],this,r)},this)};i.prototype={};var s=function(e){t.extend(i.prototype,e)};return s({get:function(t,n){r.get.apply(r,arguments)}}),s({set:function(t,n){r.set.apply(r,arguments)}}),s({remove:function(t,n){r.remove.apply(r,arguments)}}),s({clear:function(t){r.clear.apply(r,arguments)}}),i})}(),function(){define("cookie-manager",["underscore","jquery","storage","util-lib","purl"],function(e,t,n,r,i){var s=function(t,i){i=i||this,t=t&&t["cookie-manager"]||t||{},this.storage=new n(t&&t.storage||t,this);var s=["clear","getCookieHeader","setCookieHeader","set"];e(s).each(function(e){this[e]=r.getDeferredFunc(this[e],this,i)},this)};s.prototype={};var o=function(t){e.extend(s.prototype,t)};return o({clear:function(t){this.storage.clear().done(function(){t()})}}),o({getCookieHeader:function(r,i){var s=t.url(r),o=s.attr("host"),u=s.attr("port")||80,a=s.attr("path")||"/";/\/$/.test(a)||(a+="/"),this.storage.get("cookies").done(function(t){var n=e(t.cookies).filter(function(e){var t=new RegExp(e.domain+"$","i");return t.test(o)}).filter(function(e){var t=new RegExp("^"+e.path);return t.test(a)}),r=e(n).map(function(e){return e.key+"="+e.value}).join("; ");i("Cookie: "+r)})}}),o({set:function(n,r,i){var s=function(n){Array.isArray(n.cookies)||(n.cookies=[]);var s=e(r).filter(function(t){return!e(n.cookies).some(function(e){return t.key===e.key})});n.cookies=e(n.cookies).map(function(t){return e(r).each(function(e){e.key===t.key&&(t.value=e.value)}),t}),n.cookies=n.cookies.concat(s);var o=this.storage.set({cookies:n.cookies});o.done(i)};s=s.bind(this),this.storage.get("cookies").done(s)}}),o({setCookieHeader:function(i,s,o){var u={},a=e(s.split("\r\n")).filter(function(e){return/^set-cookie\:/i.test(e)}).filter(function(n){n=n.substr(11);var i=e(n.split(";")).map(t.trim),s=r.splitString(i.splice(0,1)[0],"="),o={key:s[0],value:s[1]};return e.has(u,o.key)?!1:(u[o.key]=!0,!0)}).map(function(n){n=n.substr(11);var s=e(n.split(";")).map(t.trim),o=r.splitString(s.splice(0,1)[0],"="),u={key:o[0],value:o[1]},a=e(s).reduce(function(t,n){var i=r.splitString(n,"="),s=i[0],o=i[1],u={};return/^expires$/i.test(s)?u.expires=o:/^path$/i.test(s)&&(u.path=o),e(t).extend(u),t},{}),f=t.url(i),l=f.attr("host"),c=f.attr("port")||80,h=f.attr("path")||"/";return typeof a.domain=="undefined"&&(a.domain=l),typeof a.path=="undefined"&&(a.path=h),/\/$/.test(a.path)||(a.path+="/"),e(u).extend(a),u});this.set(i,a).done(o)}}),s})}(),function(){var e=this;define("parser",["underscore","jquery","logger","util-lib"],function(e,t,n,r){var i=function(e,t){t=t||this,e=e&&e.client||e||{},this.token="<>"};i.prototype={};var s=function(t){e.extend(i.prototype,t)};return s({parseThreadList:function(i){function s(e){return t.trim(e)}function o(e){return t.trim(e.match(/(.*)\([0-9]+\)$/)[1])}function u(e){return parseInt(e.match(/.*\(([0-9]+)\)$/)[1],10)}function a(e){var t=r.splitString(e,this.token);return{filename:s(t[0]),subject:o(t[1]),responses:u(t[1])}}return e(i.split("\n")).reject(r.checkEmptyString).map(a.bind(this))}}),s({parseResponsesFromThread:function(i){function s(e){var n={};return e=t.trim(e),e[0]=="<"?n={data:e.match(/<\/b>(.*)<b>/)[1],strong:!1}:n={data:e,strong:!0},n}function o(e){return{data:t.trim(e)}}function u(e){return{data:t.trim(e)}}function a(e){return{data:t.trim(e)}}function f(e){return{data:t.trim(e)}}function l(e,t){var n=e.split(this.token);return{number:t+1,name:s(n[0]),mail:o(n[1]),info:u(n[2]),body:a(n[3]),subject:f(n[4])}}var c=e(i.split("\n")).reject(r.checkEmptyString).map(l.bind(this));return c}}),s({parseTitleFromHTML:function(t){var n=t.match(/<title>(.*?)<\/title>/i);return Array.isArray(n)?n[1]:undefined}}),s({parseFormFromHTML:function(r){var i=r.replace(/\r/,"").replace(/\n/,"").match(/(<.+?>)/g),s=function(n){if(n[1]==="/")return!1;var r=t.parseHTML(n);if(!Array.isArray(r)||r.length!==1)return!1;if(typeof r[0].tagName=="string"){var i=r[0].tagName.toLowerCase();return i==="form"}return!1},o=function(n){if(n[1]!=="/")return!1;n="<"+n.substr(2);var r=t.parseHTML(n);if(!Array.isArray(r)||r.length!==1)return!1;if(typeof r[0].tagName=="string"){var i=r[0].tagName.toLowerCase();return i==="form"}return!1},u=function(t){var n=[],r=[],i=t.length;for(var u=0;u<i;++u){var a=t[u];s(a)?r.push(u):o(a)&&(n.push({first:r[r.length-1],second:parseInt(u,10)}),r.pop())}return n},a=u(i),f={};return e(a).each(function(e){var n=i.slice(e.first,e.second+1),r=n.join(""),s=t.parseHTML(r)[0],o=t(s).attr("action"),u=t(s).attr("method").toLowerCase(),a={action:o,method:u,params:{}};t(s).children().each(function(){var e=t(this).attr("name"),n=t(this).attr("value");a.params[e]=n}),f[o]=a}),f}}),i})}(),function(){var e=this;define("client",["jquery","underscore","backbone","http-lib","storage","cookie-manager","parser","encoding","util-lib","logger"],function(e,t,n,r,i,s,o,u,a,f){function p(e,t){return"http://"+e+t}function d(e,t){return"/dat/"+t+".dat"}function v(e){return u.codeToString(u.convert(y(e),"SJIS","AUTO"))}function m(e){return u.codeToString(u.convert(y(e),"UNICODE","AUTO"))}function g(e){return t(e).map(function(e){var t=e.charCodeAt().toString(16).toUpperCase();while(t.length<2)t="0"+t;return"%"+t}).join("")}function y(e){var n=[];return t(e.split("")).each(function(e){n.push(e.charCodeAt())}),n}var l="form_append_params",c=function(e,n){n=n||this,e=e&&e.client||e||{},this.HTTP_REQ_HEADERS_DEFAULT={"User-Agent":"Monazilla/1.00"},this.http=new r(e&&e["http-lib"]||e,this),this.parser=new o(e&&e.parser||e,this),this.logger=new f(e&&e.logger||e,this),this.storage=new i(e&&e.storage||e,this),this.cookie_manager=new s(e&&e["cookie-manager"]||e||{},this);var u=["getThreadList","getSettingText","getResponsesFromThread"];t(u).each(function(e){this[e]=a.getDeferredFunc(this[e],this,n)},this);var u=["putResponseToThread"];t(u).each(function(e){this[e]=a.getDeferredFuncWillFail(this[e],this,n)},this)};c.prototype={};var h=function(e){t.extend(c.prototype,e)};return h({getThreadList:function(n,r,i){var s=p(n,"/"+r+"/subject.txt");this.http.get(s,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){i(this.parser.parseThreadList(m(e.body)))})}}),h({getSettingText:function(n,r,i){var s=p(n,"/"+r+"/SETTING.TXT"),o=this.HTTP_REQ_HEADERS_DEFAULT;t(o).extend({Host:n}),this.http.get(s,o).done(function(e){i(this.parser.parseSettingText(m(e.body)))})}}),h({getResponsesFromThread:function(n,r,i,s){var o=p(n,"/"+r+d(n,i));this.http.get(o,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){s(this.parser.parseResponsesFromThread(m(e.body)))})}}),h({putResponseToThread:function(r,i,s,o,u,a){var f=p(r,"/test/bbs.cgi?guid=ON"),c=t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:r,Referer:p(r,"/"+i+"/")}),h={},d=function(u,a){var p=function(c){var p=function(){var f=function(){var u=new e.Deferred;return this.storage.get(l).done(function(e){var n=function(){this.putResponseToThread(r,i,s,o).done(u.resolve).fail(u.reject)};n=n.bind(this);var a=this.parser.parseFormFromHTML(m(c.body))["../test/bbs.cgi?guid=ON"].params;t(t.keys(h)).each(function(e){typeof a[e]=="undefined"?delete a[e]:e==="FROM"||e==="MESSAGE"||e==="mail"||e==="time"?delete a[e]:h[e]===a[e]?delete a[e]:a[e]=v(a[e].toString())}),typeof e[l]!="object"&&(e[l]={}),t(e[l]).extend(a),this.storage.set(e).done(n)}),u};f=f.bind(this);var p=this.parser.parseTitleFromHTML(m(c.body));"書きこみました。"===p?u(m(c.body)):"■ 書き込み確認 ■"===p?a({type:"confirm",httpResponse:c,confirm:f}):a({type:"error",httpResponse:c})};p=p.bind(this);var d=function(){var n=new e.Deferred;return typeof c.headers["Set-Cookie"]!="undefined"?this.cookie_manager.setCookieHeader(f,c.headers_source).done(function(){n.resolve()}):n.resolve(),n};d=d.bind(this);var g=e.when.apply(null,[d()]);g.done(p)};p=p.bind(this);var d=function(){this.http.post(f,c,h).done(p)};d=d.bind(this);var g=function(){var n=this.storage.get(l);return n.done(function(e){t(h).extend(e[l])}),n};g=g.bind(this);var y=e.when.apply(null,[g()]);y.done(d)};d=d.bind(this);var y=function(){var r=new e.Deferred,u=function(){var n=t.clone(o);t(n).each(function(e,t){n[t]=v(e)});var u=t.clone(n);t(u).each(function(e,t){u[t]=g(e)}),t(h).extend({subject:"",bbs:i,key:s,time:1,submit:v("書き込む"),FROM:u.name,mail:u.mail,MESSAGE:u.body}),r.resolve()};return u=u.bind(this),setTimeout(u,0),r};y=y.bind(this);var b=function(n){if(n==="Cookie: ")return;t(c).extend({Cookie:n.substr(8)})},w=function(){var t=this.cookie_manager.getCookieHeader(f);return t.done(b),t};w=w.bind(this);var E=e.when.apply(null,[w(),y()]);E.done(function(){d(u,a)})}}),c})}(),function(){var e=this;requirejs.config({paths:{client:"../sources/client",socket:"../sources/socket-chrome",storage:"../sources/storage-chrome","http-lib":"../sources/http-lib","buffer-lib":"../sources/buffer-lib-chrome","util-lib":"../sources/util-lib",parser:"../sources/parser",logger:"../sources/logger","cookie-manager":"../sources/cookie-manager",formatter:"../sources/formatter"}}),define(["client"],function(e){return e})}();