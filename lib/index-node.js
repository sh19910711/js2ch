/* ===================================================
 * JavaScript 2ch-client Library
 * https://github.com/sh19910711/js2ch
 * ===================================================
 * Copyright (c) 2013 Hiroyuki Sano
 *
 * Licensed under MIT License.
 * http://opensource.org/licenses/MIT
 * =================================================== */

(function(){define("formatter",["underscore"],function(e){var t=function(){};t.prototype={};var n=e(t.prototype);return n.extend({format:function(t){return t}}),t})})(),function(){"use strict";var e=this;define("logger",["underscore","formatter"],function(e,t){var n=function(){};n.prototype={};var r=e(n.prototype);r.extend({log:function(){console.log.apply(console,arguments)}}),r.extend({debug:function(){console.debug.apply(console,arguments)}}),r.extend({info:function(){console.info.apply(console,arguments)}}),r.extend({warn:function(){console.warn.apply(console,arguments)}}),r.extend({error:function(){console.error.apply(console,arguments)}});var i=["log","debug","info","warn","error"];return e(i).each(function(r){var i=n.prototype[r];n.prototype[r]=function(){var n=Array.prototype.slice.apply(arguments);n=e(n).map(function(e){return t.format(e)}),i.apply(this,n)}}),n})}(),function(){"use strict";define("util",["jquery","underscore"],function(e,t){var n=function(){},r=t(n);return r.extend({getDeferredFunc:function(n){return function(){var t=this,r=new e.Deferred,i=arguments[arguments.length-1],s=Array.prototype.slice.apply(arguments);return setTimeout(function(){i instanceof Function?s[s.length-1]=function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}:s.push(function(){i instanceof Function&&i.apply(this,arguments),r.resolve.apply(this,arguments)}),n.apply(t,s)},0),r}}}),r.extend({splitString:function(t,n){var r=t.indexOf(n);return[t.substring(0,r),t.substring(r+n.length)]}}),r.extend({checkEmptyString:function(n){return e.trim(n).length===0}}),n})}(),function(){"use strict";var e=this;define("socket",["underscore","net","encoding","logger","util"],function(e,t,n,r,i){function a(e){return String.fromCharCode.apply(null,new Uint16Array(e))}var s=[],o=function(){};o.prototype={};var u=e(o.prototype);u.extend({create:function(n,r,i){var o=new t.Socket,u=s.length;s.push(o),setTimeout(i,0,{socketId:u})}}),u.extend({destroy:function(t){s[t].destroy()}}),u.extend({connect:function(n,r,i,o){var u=s[n];u.connect(i,r,function(){o(0)}),u.resultCode=1,u.buffer=[],u.readCallbacks=[],u.needBytes=0,u.byteCount=0,u.finished=!1,u.on("data",function(t){var n=e(t).map(function(e){return e});u.buffer=u.buffer.concat(n),u.byteCount+=n.length}),u.on("end",function(){u.finished=!0})}}),u.extend({disconnect:function(t){s[t].destroy()}}),u.extend({read:function(t,n,r){var i=s[t],o=setInterval(function(){if(!i.finished)return;clearInterval(o);if(i.byteCount>=n){var e=Math.min(n,i.byteCount);i.byteCount-=e,r({resultCode:1,data:i.buffer.splice(0,e)})}else if(i.byteCount>0){var e=i.byteCount;i.byteCount-=e,r({resultCode:1,data:i.buffer.splice(0,e)})}else r({resultCode:-1})},10)}}),u.extend({write:function(t,n,r){var i=a(n),o=s[t];o.write(i,function(){r()})}});var f=["connect","create","read","write"];return e(f).each(function(e){o.prototype[e]=i.getDeferredFunc(o.prototype[e])}),o})}(),function(){define("buffer-lib",["underscore","encoding","logger"],function(e,t){var n=function(){};n.prototype={};var r=e(n.prototype);return r.extend({convertToString:function(n,r){setTimeout(function(){r((new Buffer(t.convert(n,"UTF-8","SJIS"))).toString("UTF-8"))},0)}}),r.extend({convertToBuffer:function(t,n){setTimeout(function(){var e=new ArrayBuffer(t.length*2),r=new Uint16Array(e);for(var i=0;i<t.length;++i)r[i]=t.charCodeAt(i);n(e)},0)}}),r.extend({getByteLength:function(t,n){console.log("str: ",t),setTimeout(function(){n(Buffer.byteLength(t,"sjis"))},0)}}),n})}(),function(){"use strict";var e=this;define("http-lib",["jquery","underscore","socket","purl","async","util","buffer-lib","logger"],function(e,t,n,r,i,s,o,u){function v(t,n){var r=new e.Deferred;return n instanceof Function||(n=r.resolve),f.convertToBuffer(t,n),r}function m(t){var n=t.split(c),r=n[0].split(" "),i=n.slice(1),o=i.map(function(t){return s.splitString(t,":").map(e.trim)}),u={"HTTP-Version":r[0],"Status-Code":r[1]};return o.forEach(function(e){u[e[0]]=e[1]}),u}function g(e){return s.splitString(e,c+c)[0]}function y(e){return s.splitString(e,c+c)[1]}function b(e){return t(t.keys(e)).map(function(t){return t+"="+e[t]}).join("&")}function w(e){var t=m(g(e)),n={headers:t,headers_source:g(e),body:y(e)};return n}var a=new n,f=new o,l=new u,c="\r\n",h=80,p=function(){};p.prototype={};var d=t(p.prototype);d.extend({get:function(r,s,o){function m(e){a.create("tcp",{},function(t){d=t.socketId,e(null)})}function g(e){a.connect(d,p.host,p.port,function(){var n=[];n.push("GET "+p.path+" HTTP/1.0"+c),t(t.keys(s)).each(function(e){n.push(e+": "+s[e]+c)}),n.push("Connection: close"+c),n.push(c);var r=n.join("");v(r).done(function(t){a.write(d,t,function(){e(null)})})})}function y(e){function s(){a.read(d,256,function(r){if(r.resultCode<0)clearTimeout(i),n=t(n).map(function(e){return e}),a.destroy(d),f.convertToString(n,function(t){u=w(t),e(null)});else{var o=[],l=new Uint8Array(r.data);t(l).each(function(e){o.push(e)}),n=n.concat(o),i=setTimeout(s,0)}})}var n=[],r="",i=setTimeout(s,0)}var u={},l=e.url(r),p={host:l.attr("host"),path:l.attr("path"),port:parseInt(l.attr("port")||h,10)},d;i.series([m,g,y],function(){o(u)})}}),d.extend({post:function(r,s,o,u){function g(e){a.create("tcp",{},function(t){m=t.socketId,e(null)})}function y(e){a.connect(m,d.host,d.port,function(){function u(o){d.query!=""&&(r+="?"+d.query),n.push("POST "+r+" HTTP/1.1"+c),t(t.keys(s)).each(function(e){n.push(e+": "+s[e]+c)}),n.push("Content-Length: "+o+c),n.push("Connection: close"+c),n.push(c),n.push(i);var u=n.join("");v(u).done(function(t){a.write(m,t,function(){e(null)})})}var n=[],r=d.path,i=b(o);f.getByteLength(i,u)})}function E(e){function s(){a.read(m,256,function(r){if(r.resultCode<0)clearTimeout(i),n=t(n).map(function(e){return e}),a.destroy(m),f.convertToString(n,function(t){l=w(t),e(null)});else{var o=[],u=new Uint8Array(r.data);t(u).each(function(e){o.push(e)}),n=n.concat(o),i=setTimeout(s,0)}})}var n=[],r="",i=setTimeout(s,0)}var l={},p=e.url(r),d={host:p.attr("host"),path:p.attr("path"),query:p.attr("query"),port:p.attr("port")||h},m;i.series([g,y,E],function(){u(l)})}});var E=["get","post"];return t(E).each(function(e){p.prototype[e]=s.getDeferredFunc(p.prototype[e])}),p})}(),function(){"use strict";var e=this;define("storage",["underscore","jquery","util","sqlite3"],function(e,t,n,r){var i="items",s="js2ch.db",o=function(e){var n=this;n.callbacks=new t.Callbacks("once"),n.target=e&&e.target||s,this.sqlite=r.verbose();var o=new this.sqlite.Database(n.target);o.get("SELECT COUNT(*) FROM sqlite_master WHERE type='table' and name='"+i+"'",function(e,t){var r=t["COUNT(*)"];r===0?o.run("CREATE TABLE "+i+" (key, value)",function(){n.callbacks.fire(),o.close()}):n.callbacks.fire()})};o.prototype={};var u=e(o.prototype);u.extend({get:function f(t,n){if(!this.callbacks.fired()){this.callbacks.add(f.bind(this,t,n));return}var r={},o={};typeof t=="string"?(t=[t],e(t).each(function(e){r[e]=undefined})):Array.isArray(t)?e(t).each(function(e){r[e]=undefined}):typeof t=="object"&&(r=e(t).clone(),t=e.keys(t)),e(t).each(function(e){o[e]=0});var u=new this.sqlite.Database(s);u.all("SELECT key,value FROM "+i,function(t,i){var s=e(r).clone(),a=e(i).filter(function(e){return typeof o[e.key]!="undefined"});e(a).each(function(e){s[e.key]=JSON.parse(e.value)}),u.close(),n(s)})}}),u.extend({set:function l(n,r){if(!this.callbacks.fired()){this.callbacks.add(l.bind(this,n,r));return}var o={},u=e.keys(n);e(u).each(function(e){o[e]=JSON.stringify(n[e])});var a=new this.sqlite.Database(s);a.serialize(function(){var n=[];(function(){var r=new t.Deferred,s=a.prepare("UPDATE "+i+" SET value = ? WHERE key = ?");e(o).each(function(e,t){s.run(e,t,function(){r.resolve()})}),s.finalize(),n.push(r)})(),function(){e(o).each(function(e,r){var s=new t.Deferred;a.get("SELECT * FROM "+i+" WHERE key = "+r,function(t,n){var o=a.prepare("INSERT INTO "+i+" VALUES(?,?)");o.run(r,e,function(){o.finalize(),s.resolve()})}),n.push(s)})}(),t.when.apply(null,n).done(function(){a.close(),r()})})}}),u.extend({remove:function c(n,r){if(!this.callbacks.fired()){this.callbacks.add(c.bind(this,n,r));return}typeof n=="string"&&(n=[n]);var o=new this.sqlite.Database(s),u=o.prepare("DELETE FROM "+i+" WHERE key = ?"),a=[];e(n).each(function(e){var n=new t.Deferred;u.run(e,function(e,t){n.resolve()}),a.push(n)}),t.when.apply(null,a).done(function(){u.finalize(),o.close(),r()})}}),u.extend({clear:function h(e){if(!this.callbacks.fired()){this.callbacks.add(h.bind(this,e));return}var t=new this.sqlite.Database(s);t.run("DELETE FROM "+i,function(){t.close(),e()})}});var a=["get","set","remove","clear"];return e(a).each(function(e){o.prototype[e]=n.getDeferredFunc(o.prototype[e])}),o})}(),function(){"use strict";define("cookie-manager",["underscore","jquery","storage","util","purl"],function(e,t,n,r,i){var s=function(e){this.storage=new n(e&&e.storage||{})};s.prototype={};var o=e(s.prototype);o.extend({clear:function(t){this.storage.clear(function(){t()})}}),o.extend({getCookieHeader:function(r,i){var s=t.url(r),o=s.attr("host"),u=s.attr("port")||80,a=s.attr("path")||"/";/\/$/.test(a)||(a+="/"),this.storage.get("cookies").done(function(t){var n=e(t.cookies).filter(function(e){var t=new RegExp(e.domain+"$","i");return t.test(o)}).filter(function(e){var t=new RegExp("^"+e.path);return t.test(a)}),r=e(n).map(function(e){return e.key+"="+e.value}).join("; ");i("Cookie: "+r)})}}),o.extend({set:function(t,n,r){this.storage.get("cookies").done(function(e){Array.isArray(e.cookies)||(e.cookies=[]),e.cookies=e.cookies.concat(n);var t=this.storage.set({cookies:e.cookies});t.done(r)}.bind(this))}}),o.extend({setCookieHeader:function(i,s,o){var u=e(s.split("\r\n")).filter(function(e){return/^set-cookie\:/i.test(e)}).map(function(n){n=n.substr(11);var s=e(n.split(";")).map(t.trim),o=r.splitString(s.splice(0,1)[0],"="),u={key:o[0],value:o[1]},a=e(s).reduce(function(t,n){var i=r.splitString(n,"="),s=i[0],o=i[1],u={};return/^expires$/i.test(s)?u.expires=o:/^path$/i.test(s)&&(u.path=o),e(t).extend(u),t},{}),f=t.url(i),l=f.attr("host"),c=f.attr("port")||80,h=f.attr("path")||"/";return typeof a.domain=="undefined"&&(a.domain=l),typeof a.path=="undefined"&&(a.path=h),/\/$/.test(a.path)||(a.path+="/"),e(u).extend(a),u});this.set(i,u).done(o)}});var u=["clear","getCookieHeader","setCookieHeader","set"];return e(u).each(function(e){s.prototype[e]=r.getDeferredFunc(s.prototype[e])}),s})}(),function(){"use strict";var e=this;define("parser",["underscore","jquery","logger","util"],function(e,t,n,r){var i=function(){this.token="<>"};i.prototype={};var s=e(i.prototype);return s.extend({parseThreadList:function(i){function s(e){return t.trim(e)}function o(e){return t.trim(e.match(/(.*)\([0-9]+\)$/)[1])}function u(e){return parseInt(e.match(/.*\(([0-9]+)\)$/)[1],10)}function a(e){var t=r.splitString(e,this.token);return{filename:s(t[0]),subject:o(t[1]),responses:u(t[1])}}return e(i.split("\n")).reject(r.checkEmptyString).map(a.bind(this))}}),s.extend({parseResponsesFromThread:function(i){function s(e){var n={};return e=t.trim(e),e[0]=="<"?n={data:e.match(/<\/b>(.*)<b>/)[1],strong:!1}:n={data:e,strong:!0},n}function o(e){return t.trim(e)}function u(e){return t.trim(e)}function a(e){return t.trim(e)}function f(e){return t.trim(e)}function l(e,t){var n=e.split(this.token);return{number:t+1,name:s(n[0]),mail:o(n[1]),info:u(n[2]),body:a(n[3]),subject:f(n[4])}}var c=e(i.split("\n")).reject(r.checkEmptyString).map(l.bind(this));return c}}),i})}(),function(){"use strict";var e=this;define("client",["jquery","underscore","backbone","http-lib","cookie-manager","parser","encoding","util","logger"],function(e,t,n,r,i,s,o,u,a){function v(e,t){return"http://"+e+t}function m(e,t){return"/dat/"+t+".dat"}function g(e){return o.codeToString(o.convert(b(e),"SJIS","AUTO"))}function y(e){return t(e).map(function(e){return"%"+e.charCodeAt().toString(16).toUpperCase()}).join("")}function b(e){var n=[];return t(e.split("")).each(function(e){n.push(e.charCodeAt())}),n}var f=new r,l=new s,c=new a,h=new i,p=function(){this.HTTP_REQ_HEADERS_DEFAULT={"User-Agent":"Monazilla/1.00"}};p.prototype={};var d=t(p.prototype);d.extend({getThreadList:function(n,r,i){var s=v(n,"/"+r+"/subject.txt");f.get(s,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){i(l.parseThreadList(e.body))})}}),d.extend({getSettingText:function(n,r,i){var s=v(n,"/"+r+"/SETTING.TXT");f.get(s,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){i(l.parseSettingText(e.body))})}}),d.extend({getResponsesFromThread:function(n,r,i,s){var o=v(n,"/"+r+m(n,i));f.get(o,t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:n})).done(function(e){s(l.parseResponsesFromThread(e.body))})}}),d.extend({putResponseToThread:function(r,i,s,o,u){function c(n){function r(t){var r=[];typeof t.headers["Set-Cookie"]!="undefined"&&r.push(h.setCookieHeader(a,t.headers_source)),e.when.apply(null,r).done(function(){n(t)})}console.log("@write: start");var u=t(o).clone();t(u).each(function(e,t){u[t]=g(e)});var c=t(u).clone();t(c).each(function(e,t){c[t]=y(e)}),f.post(a,l,{bbs:i,key:s,time:1,submit:g("上記全てを承諾して書き込む"),FROM:c.name,mail:c.mail,MESSAGE:c.body,yuki:"akari"}).done(r)}var a=v(r,"/test/bbs.cgi?guid=ON"),l=t(this.HTTP_REQ_HEADERS_DEFAULT).extend({Host:r,Referer:v(r,"/"+i+"/")});console.log("@client: before write");var p=e.when.apply(null,[h.getCookieHeader(a).done(function(e){if(e==="Cookie: ")return;t(l).extend({Cookie:e.substr(7)})})]);p.done(function(){console.log("@client: after setting"),console.log("@client: after setting headers = ",l),c(u)})}});var w=["getThreadList","getSettingText","getResponsesFromThread","putResponseToThread"];return t(w).each(function(e){p.prototype[e]=u.getDeferredFunc(p.prototype[e])}),p})}(),function(){"use strict";var e=this;requirejs.config({paths:{client:"./sources/client",socket:"./sources/socket-node",storage:"./sources/storage-node","http-lib":"./sources/http-lib",parser:"./sources/parser","buffer-lib":"./sources/buffer-lib-node",util:"./sources/util","cookie-manager":"./sources/cookie-manager",logger:"./sources/logger",formatter:"./sources/formatter",encoding:"./lib/encoding"}}),define(["client"],function(e){return e})}();